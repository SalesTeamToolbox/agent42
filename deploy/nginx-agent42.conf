# Nginx reverse proxy for Agent42
# Template: __DOMAIN__ → localhost:__PORT__
#
# This is a TEMPLATE — do not install directly.
# The install script replaces __DOMAIN__ and __PORT__ automatically:
#   bash deploy/install-server.sh
#
# Manual install:
#   sed -e 's/__DOMAIN__/yourdomain.com/g' -e 's/__PORT__/8002/g' \
#       deploy/nginx-agent42.conf | sudo tee /etc/nginx/sites-available/agent42
#   sudo ln -s /etc/nginx/sites-available/agent42 /etc/nginx/sites-enabled/
#   sudo nginx -t && sudo systemctl reload nginx
#   sudo certbot --nginx -d yourdomain.com

# Rate limiting zone — shared across all workers
limit_req_zone $binary_remote_addr zone=agent42_login:10m rate=5r/m;

# Upstream — keeps proxy_pass clean and allows easy port changes
upstream agent42_backend {
    server 127.0.0.1:__PORT__;
}

server {
    listen 80;
    listen [::]:80;
    server_name __DOMAIN__;

    # Let's Encrypt challenge (certbot will modify this block)
    location /.well-known/acme-challenge/ {
        root /var/www/html;
    }

    # Redirect everything else to HTTPS (certbot adds this automatically,
    # but we include it so the config works before certbot runs too)
    location / {
        return 301 https://$host$request_uri;
    }
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name __DOMAIN__;

    # ── SSL (certbot will replace these with real certs) ──────────────
    # Placeholder — certbot --nginx will auto-configure these lines:
    ssl_certificate     /etc/letsencrypt/live/__DOMAIN__/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/__DOMAIN__/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # ── Security headers ─────────────────────────────────────────────
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # ── Logging ──────────────────────────────────────────────────────
    access_log /var/log/nginx/agent42_access.log;
    error_log  /var/log/nginx/agent42_error.log;

    # ── Client limits ────────────────────────────────────────────────
    client_max_body_size 50M;   # Allow file uploads (images, repos, etc.)

    # ── Rate limit the login endpoint ────────────────────────────────
    location /api/login {
        limit_req zone=agent42_login burst=3 nodelay;
        proxy_pass http://agent42_backend;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ── WebSocket — dashboard real-time updates ──────────────────────
    location /ws {
        proxy_pass http://agent42_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade           $http_upgrade;
        proxy_set_header Connection        "upgrade";
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket timeout — keep connections alive for long-running tasks
        proxy_read_timeout    86400s;
        proxy_send_timeout    86400s;
    }

    # ── Everything else → Agent42 backend ────────────────────────────
    location / {
        proxy_pass http://agent42_backend;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Buffering off for streaming responses (SSE, long-polling)
        proxy_buffering off;

        # Reasonable timeouts for agent operations
        proxy_read_timeout  300s;
        proxy_send_timeout  300s;
    }
}
